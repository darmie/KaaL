<?xml version="1.0" encoding="UTF-8"?>
<!--
  KaaL System Composition - Microkit Configuration

  This system.xml defines a complete KaaL system with:
  - Serial driver (UART)
  - Filesystem service (VFS)
  - Network driver (future)

  Build with: microkit build system.xml
  Run with: qemu-system-aarch64 -M virt -cpu cortex-a53 -kernel loader.img -nographic
-->
<system>
  <!--
    Memory Regions
    Define shared memory and device MMIO regions
  -->

  <!-- UART MMIO region (ARM QEMU virt machine) -->
  <memory_region name="uart_mmio" size="0x1000" phys_addr="0x09000000"/>

  <!-- Shared memory for IPC between components -->
  <memory_region name="serial_to_fs_ring" size="0x10000"/>
  <memory_region name="net_to_app_ring" size="0x10000"/>

  <!--
    Protection Domains (Components)
    Each PD is an isolated component with its own address space
  -->

  <!-- Serial Driver Component -->
  <protection_domain name="serial_driver" priority="200">
    <program_image path="serial_driver.elf"/>

    <!-- Map UART MMIO registers -->
    <map mr="uart_mmio" vaddr="0x10000000" perms="rw" cached="false"/>

    <!-- Map shared ring buffer with filesystem -->
    <map mr="serial_to_fs_ring" vaddr="0x20000000" perms="rw"/>

    <!-- UART interrupt (IRQ 33 on ARM QEMU virt) -->
    <irq irq="33" id="1"/>
  </protection_domain>

  <!-- Filesystem Service Component -->
  <protection_domain name="filesystem" priority="100">
    <program_image path="filesystem.elf"/>

    <!-- Map shared ring buffer with serial driver -->
    <map mr="serial_to_fs_ring" vaddr="0x20000000" perms="rw"/>

    <!-- Map shared ring buffer with network -->
    <map mr="net_to_app_ring" vaddr="0x21000000" perms="rw"/>
  </protection_domain>

  <!-- Network Driver Component (future) -->
  <protection_domain name="network_driver" priority="150">
    <program_image path="network_driver.elf"/>

    <!-- Map shared ring buffer with apps -->
    <map mr="net_to_app_ring" vaddr="0x21000000" perms="rw"/>

    <!-- E1000 IRQ (typically IRQ 11 on x86, varies on ARM) -->
    <!-- <irq irq="11" id="2"/> -->
  </protection_domain>

  <!--
    Channels (IPC Endpoints)
    Define communication channels between components
  -->

  <!-- Serial → Filesystem channel -->
  <channel>
    <end pd="serial_driver" id="1"/>
    <end pd="filesystem" id="2"/>
  </channel>

  <!-- Network → Filesystem channel -->
  <channel>
    <end pd="network_driver" id="3"/>
    <end pd="filesystem" id="4"/>
  </channel>
</system>
